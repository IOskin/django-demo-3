{% extends "shop/base.html" %}

{% block title %}Список товаров{% endblock %}

{% block content %}
<h1 class="h4 mb-3">Список товаров</h1>

{% if show_filters %}
    <form method="get" class="row g-2 mb-3">
        <div class="col-md-3">
            <input type="text" name="search" class="form-control" placeholder="Поиск"
                   value="{{ request.GET.search }}">
        </div>
        <div class="col-md-3">
            <select name="supplier" class="form-select">
                <option value="">Все поставщики</option>
                {% for s in suppliers %}
                    <option value="{{ s.id }}" {% if request.GET.supplier == s.id|stringformat:"s" %}selected{% endif %}>
                        {{ s.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select name="ordering" class="form-select">
                <option value="">Без сортировки</option>
                <option value="stock_asc" {% if request.GET.ordering == 'stock_asc' %}selected{% endif %}>
                    Количество по возрастанию
                </option>
                <option value="stock_desc" {% if request.GET.ordering == 'stock_desc' %}selected{% endif %}>
                    Количество по убыванию
                </option>
            </select>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">Применить</button>
        </div>
    </form>
{% endif %}

<div class="table-responsive">
    <table class="table table-striped align-middle">
        <thead>
        <tr>
            <th>Фото</th>
            <th>Наименование</th>
            <th>Категория</th>
            <th>Описание</th>
            <th>Производитель</th>
            <th>Поставщик</th>
            <th>Цена</th>
            <th>Ед.</th>
            <th>Кол-во</th>
            <th>Скидка, %</th>
            {% if role == 'admin' %}
                <th></th>
            {% endif %}
        </tr>
        </thead>
        <tbody>
        {% for product in products %}
            {% with row_class="" %}
                {% if product.stock_quantity == 0 %}
                    {% with row_class="out-of-stock" %}{% endwith %}
                {% elif product.discount_percent > 15 %}
                    {% with row_class="discount-high" %}{% endwith %}
                {% endif %}
            {% endwith %}
            <tr class="{{ row_class }}">
                <td>
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" style="max-width: 80px; max-height: 80px;">
                    {% else %}
                        <img src="https://via.placeholder.com/80x80?text=No+Image" alt="Нет фото">
                    {% endif %}
                </td>
                <td>{{ product.name }}</td>
                <td>{{ product.category.name }}</td>
                <td>{{ product.description }}</td>
                <td>{{ product.manufacturer.name }}</td>
                <td>{{ product.supplier.name }}</td>
                <td>
                    {% if product.has_discount %}
                        <span class="price-original">{{ product.price }}</span>
                        <span>{{ product.final_price }}</span>
                    {% else %}
                        <span>{{ product.price }}</span>
                    {% endif %}
                </td>
                <td>{{ product.get_unit_display }}</td>
                <td>{{ product.stock_quantity }}</td>
                <td>{{ product.discount_percent }}</td>
                {% if role == 'admin' %}
                    <td>
                        <a href="{% url 'shop:product_update' product.pk %}" class="btn btn-sm btn-outline-primary">Изменить</a>
                        <a href="{% url 'shop:product_delete' product.pk %}" class="btn btn-sm btn-outline-danger">Удалить</a>
                    </td>
                {% endif %}
            </tr>
        {% empty %}
            <tr>
                <td colspan="11" class="text-center">Товары отсутствуют</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


